<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>0001-protocol-messages - The IOTA Protocol RFC Book</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="../0001-protocol-messages/0001-protocol-messages.html" class="active">0001-protocol-messages</a></li><li class="chapter-item expanded "><a href="../0005-white-flag/0005-white-flag.html">0005-white-flag</a></li><li class="chapter-item expanded "><a href="../0008-uniform-random-tip-selection/0008-uniform-random-tip-selection.html">0008-uniform-random-tip-selection</a></li><li class="chapter-item expanded "><a href="../0012-milestone-merkle-validation/0012-milestone-merkle-validation.html">0012-milestone-merkle-validation</a></li><li class="chapter-item expanded "><a href="../0015-binary-to-ternary-encoding/0015-binary-to-ternary-encoding.html">0015-binary-to-ternary-encoding</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">The IOTA Protocol RFC Book</h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <ul>
<li>Feature name:<code>New Protocol Messages</code></li>
<li>Start date: 2019-12-19</li>
<li>RFC PR: <a href="https://github.com/iotaledger/protocol-rfcs/pull/0001">iotaledger/protocol-rfcs#0001</a></li>
<li>Node software implementation issues: 
<ul>
<li><a href="https://github.com/iotaledger/iri/issues/1072">iotaledger/iri#1072</a></li>
</ul>
</li>
</ul>
<h1><a class="header" href="#summary" id="summary">Summary</a></h1>
<p>Defines the changes that were introduced during the network rewrite. <a href="https://github.com/iotaledger/iri/issues/1072">iotaledger/iri#1072</a>. This is mainly the introduction of new TLV (type-length-value) messages. A header was added to each message, allowing us to create different message types and support different versions of the protocol. A handshake message was also introduced to help establish manageable connections with neighbors.</p>
<p>This RFC also defines the STING protocol introduced by the Hornet team. It separates between transaction requests and the transactions, allows to request milestones by index, and introduces the concept of heartbeats.</p>
<p>Here is a table summarizing all the new message types. The 3-6 types are part of STING:</p>
<table><thead><tr><th>Type #</th><th>Message Type</th></tr></thead><tbody>
<tr><td>1</td><td>Handshake</td></tr>
<tr><td>2</td><td>Legacy Transaction Gossip</td></tr>
<tr><td>3</td><td>Milestone Request</td></tr>
<tr><td>4</td><td>Transaction</td></tr>
<tr><td>5</td><td>Transaction Request</td></tr>
<tr><td>6</td><td>Heartbeat</td></tr>
</tbody></table>
<h1><a class="header" href="#motivation" id="motivation">Motivation</a></h1>
<p><em><strong>The network rewrite change</strong></em></p>
<ul>
<li>
<p>Ability to kick-out a compromised/malfunctioning neighbor while preserving overall architecture performance. This means that a malfunctioning neighbor will only affect its own relationship with the node and will not affect how the node  treats other neighbors.</p>
</li>
<li>
<p>Drop support for UDP which is in practice slow (due to lack of congestion control) and not so reliable. Only utilize TCP.</p>
</li>
<li>
<p>Enabling possibility to enforce global and per neighbor rate limits in both ingress and egress directions. </p>
</li>
<li>
<p>Enabling prioritization of message types.</p>
</li>
<li>
<p>Enabling the addition of new message types and versioning the protocol. Thus paving the way for STING.</p>
</li>
</ul>
<p><em><strong>STING</strong></em></p>
<ul>
<li>Allow for faster syncing by
<ul>
<li>Separating between requests and transaction data.</li>
<li>Allowing to request specific milestones by index.</li>
<li>Sharing between nodes information on the milestones in their databases via heartbeats.</li>
</ul>
</li>
<li>Eliminates fragmentation of request messages. In the legacy gossip messages exceeded TCP's MTU of 1,500 bytes, meaning all gossip transmissions were fragmented by TCP to two packets. Now, at least the transaction requests will not be fragmented. Transaction messages are still fragmented unfortunately.</li>
</ul>
<h1><a class="header" href="#detailed-design" id="detailed-design">Detailed design</a></h1>
<h2><a class="header" href="#tlv-messages---protocol-version-1" id="tlv-messages---protocol-version-1"><strong>TLV Messages - Protocol Version 1</strong></a></h2>
<p>The network rewrite introduces a new breaking protocol between nodes which works with type-length-value (TLV) denoted messages. Meaning that each sent message is composed of a header followed by the message itself.</p>
<table><thead><tr><th>Order</th><th>Name</th><th>Length (byte)</th><th>Desc</th></tr></thead><tbody>
<tr><td>1</td><td>Header</td><td>3</td><td>Metadata of message</td></tr>
<tr><td>2</td><td>Message</td><td>Var</td><td>Message itself</td></tr>
</tbody></table>
<h4><a class="header" href="#header" id="header">Header</a></h4>
<p>Each message in the protocol is denoted by a 3 byte header:</p>
<table><thead><tr><th>Order</th><th>Name</th><th>Length (byte)</th><th>Type</th><th>Desc</th></tr></thead><tbody>
<tr><td>1</td><td>Type</td><td>1</td><td>byte</td><td>Type of message</td></tr>
<tr><td>2</td><td>Length</td><td>2</td><td>uint16 (Big Endian)</td><td>Length of message (65 KB max)</td></tr>
</tbody></table>
<h4><a class="header" href="#handshake" id="handshake">Handshake</a></h4>
<p>The handshake message is the first message which must be sent and received to/from a neighbor. It is used to construct the identity of the neighbor. If the advertised server socket port, coordinator address or mwm does not correspond to the receiving nodeâ€™s configuration, the connection is dropped. It also sends its support for gossip protocol versions as a little-endian byte array. The nodes can use that information to know what message types can be transmitted to the peers.
Each index of a bit in the byte array corresponds to a supported gossip protocol version. If the bit on that index is turned on, then the corresponding protocol version is supported by the node. The LSB of the first byte has index 1, the LSB of the second byte has index 9, the LSB of the third byte has index 17, and so on.
For example, <code>[01101110, 01010001]</code> denotes that this node supports protocol versions 2, 3, 4, 6, 7, 9, 13 and 15. Thus, the length of the byte array depends on the number of protocol versions supported. Thanks to the <code>length</code> field given in the header, the peer can parse the array correctly.</p>
<table><thead><tr><th>Order</th><th>Description</th><th>Type</th><th>Length (bytes)</th></tr></thead><tbody>
<tr><td>1</td><td>Neighbor's server socket port number, range 1024-65535</td><td>uint16 (Big Endian)</td><td>2</td></tr>
<tr><td>2</td><td>Timestamp in milliseconds since Unix epoch - when the handshake packet was constructed. The node uses it to calculate the latency to/from the neighbor</td><td>uint64 (Big Endian)</td><td>8</td></tr>
<tr><td>3</td><td>Neighbor's used coordinator address. Encoded with 5 trits in a byte</td><td>byte array (<code>t5b1</code>)</td><td>49</td></tr>
<tr><td>4</td><td>Own used minimum weight magnitude</td><td>byte</td><td>1</td></tr>
<tr><td>5</td><td>Supported protocol versions</td><td>byte array (Little Endian)</td><td>1 - 32</td></tr>
</tbody></table>
<h4><a class="header" href="#transaction-gossip" id="transaction-gossip">Transaction Gossip</a></h4>
<p>Contains the transaction data and a hash of a requested transaction. The data is encoded with 5 trits in a byte (<code>t5b1</code>). If the requested hash corresponds to the hash of the transaction data, the receiving node is instructed to send back a random tip.
The total size of this message varies between 341-1653 bytes due to signature message fragment compaction.</p>
<h5><a class="header" href="#signature-message-fragment-compaction" id="signature-message-fragment-compaction">Signature Message Fragment Compaction</a></h5>
<p>The byte encoded transaction data is truncated by removing all suffix 0 bytes (9 trytes) from the signature message fragment before transmission. This can reduce the size up to 81.7%. Spam transactions, however, can prevent this reduction easily by adding data at the end of the signature message fragment.</p>
<table><thead><tr><th>Order</th><th>Description</th><th>Type</th><th>Length (bytes)</th></tr></thead><tbody>
<tr><td>1</td><td>Transaction Data</td><td>byte array (<code>t5b1</code>)</td><td>292 - 1604</td></tr>
<tr><td>2</td><td>Requested Hash</td><td>byte array (<code>t5b1</code>)</td><td>49</td></tr>
</tbody></table>
<h2><a class="header" href="#sting---protocol-version-2" id="sting---protocol-version-2">STING - Protocol Version 2</a></h2>
<p>STING is an extension to the IOTA protocol. It breaks the transaction gossip into Transaction and Transaction Request messages. Besides that it adds the Milestone Request and Heartbeat messages.</p>
<h4><a class="header" href="#milestone-request" id="milestone-request">Milestone Request</a></h4>
<p>Requests a milestones by the index. Expects to receive in response the milestone bundle for the specified index.</p>
<table><thead><tr><th>Order</th><th>Description</th><th>Type</th><th>Length (bytes)</th></tr></thead><tbody>
<tr><td>1</td><td>Milestone Index</td><td>uint32 (Big Endian)</td><td>4</td></tr>
</tbody></table>
<h4><a class="header" href="#transaction" id="transaction">Transaction</a></h4>
<p>The transaction trytes with a 5 trits to a byte encoding. Does not expect any message in return. The size remains dynamic to due to signature message compaction.</p>
<table><thead><tr><th>Order</th><th>Description</th><th>Type</th><th>Length (bytes)</th></tr></thead><tbody>
<tr><td>1</td><td>Transaction Data</td><td>byte array (<code>t5b1</code>)</td><td>292 - 1604</td></tr>
</tbody></table>
<h4><a class="header" href="#heartbeat" id="heartbeat">Heartbeat</a></h4>
<p>Relays the node's last and first solid milestone indexes. The first one is the milestone where the node pruned at. If no pruning was done on the node it will start on the global snapshot milestone.  This is used to help a syncing node know what data their neighbor has.
The heartbeat message will be sent to the peers every time the node solidifies on a new milestone or when pruning is done.</p>
<table><thead><tr><th>Order</th><th>Description</th><th>Type</th><th>Length (bytes)</th></tr></thead><tbody>
<tr><td>1</td><td>Last solid milestone index</td><td>uint32 (Big Endian)</td><td>4</td></tr>
<tr><td>2</td><td>First solid milestone index</td><td>unit32 (Big Endian)</td><td>4</td></tr>
</tbody></table>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../introduction.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../0005-white-flag/0005-white-flag.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../introduction.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../0005-white-flag/0005-white-flag.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
